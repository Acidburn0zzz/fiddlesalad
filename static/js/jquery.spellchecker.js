(function(c){c.fn.extend({spellchecker:function(a,b){return this.each(function(){var d=c(this).data("spellchecker");if(d&&String===a.constructor&&d[a])d[a](b);else d?d.init():(c(this).data("spellchecker",new g(this,Object===a.constructor?a:null)),String===a.constructor&&c(this).data("spellchecker")[a](b))})}});var g=function(a,b){this.options=c.extend({url:"checkspelling.php",lang:"en",engine:"pspell",addToDictionary:!1,wordlist:{action:"after",element:a},suggestBoxPosition:"below",innerDocument:!1},
b||{});this.$domObj=c(a);this.elements={};this.init()};g.prototype={init:function(){var a=this;this.createElements();this.$domObj.addClass("spellcheck-container");c(document).bind("click",function(b){!c(b.target).hasClass("spellcheck-word-highlight")&&!c(b.target).parents().filter(".spellcheck-suggestbox").length&&a.hideBox()})},check:function(a){var b=this,d=this.$domObj.get(0).nodeName;d=="TEXTAREA"||d=="INPUT"?(this.type="textarea",d=c.trim(this.$domObj.val().replace(RegExp("<[^>]+>","g"),"").replace(RegExp("^[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]+[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]$|\\n|\\t|\\s{2,}",
"g")," "))):(this.type="html",d=c.trim(this.$domObj.text().replace(RegExp("^[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]+[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]$|\\n|\\t|\\s{2,}","g")," ")));this.postJson(this.options.url,{text:encodeURIComponent(d).replace(/%20/g,"+")},function(c){b.type=="html"&&b.options.innerDocument?b.highlightWords(c,a):b.buildBadwordsBox(c,a)})},highlightWords:function(a,b){if(a.length){var d=this,e=this.$domObj.html();c.each(a,function(a,c){e=e.replace(RegExp("([^a-zA-Z\\u00A1-\\uFFFF])("+
c+")([^a-zA-Z\\u00A1-\\uFFFF])","g"),'$1<span class="spellcheck-word-highlight">$2</span>$3')});this.$domObj.html(e).find(".spellcheck-word-highlight").each(function(){d.elements.highlightWords.push(c(this).click(function(){d.suggest(this)}))});b&&b()}else b.call(this.$domObj,!0)},buildBadwordsBox:function(a,b){if(a.length){var d=this,e=[];c(this.options.wordlist.element)[this.options.wordlist.action](this.elements.$badwords);this.elements.$badwords.empty();c.each(a,function(a,b){c.inArray(b,e)===
-1&&(d.elements.highlightWords.push(c('<span class="spellcheck-word-highlight">'+b+"</span>").click(function(){d.suggest(this)}).appendTo(d.elements.$badwords).after('<span class="spellcheck-sep">,</span> ')),e.push(b))});c(".spellcheck-sep:last",d.elements.$badwords).addClass("spellcheck-sep-last");b&&b()}else b.call(this.$domObj,!0)},suggest:function(a){var b=this,a=c(a),d=a.offset();this.$curWord=a;if(this.options.innerDocument)this.elements.$suggestBox=this.elements.$body.find(".spellcheck-suggestbox"),
this.elements.$suggestWords=this.elements.$body.find(".spellcheck-suggestbox-words"),this.elements.$suggestFoot=this.elements.$body.find(".spellcheck-suggestbox-foot");this.elements.$suggestFoot.hide();this.elements.$suggestBox.stop().hide().css({opacity:1,width:"auto",left:d.left+"px",top:this.options.suggestBoxPosition=="above"?d.top-(a.outerHeight()+10)+"px":d.top+a.outerHeight()+"px"}).fadeIn(200);this.elements.$suggestWords.html("<em>Loading..</em>");this.postJson(this.options.url,{suggest:encodeURIComponent(c.trim(a.text()))},
function(a){b.buildSuggestBox(a,d)})},buildSuggestBox:function(a,b){var d=this,e=this.$curWord;this.elements.$suggestWords.empty();for(var f=0;f<(a.length<5?a.length:5);f++)this.elements.$suggestWords.append(c('<a href="#">'+a[f]+"</a>").addClass(!f?"first":"").click(function(){return!1}).mousedown(function(a){a.preventDefault();d.replace(this.innerHTML);d.hideBox()}));!f&&this.elements.$suggestWords.append("<em>(no suggestions)</em>");f=window.innerHeight?window.innerHeight:c(window).height();this.elements.$suggestFoot.show();
d.elements.$suggestBox.css({top:this.options.suggestBoxPosition=="above"||b.top+e.outerHeight()+this.elements.$suggestBox.outerHeight()>f+10?b.top-(this.elements.$suggestBox.height()+5)+"px":b.top+e.outerHeight()+"px",width:"auto",left:this.elements.$suggestBox.outerWidth()+b.left>c("body").width()?b.left-this.elements.$suggestBox.width()+e.outerWidth()+"px":b.left+"px"})},hideBox:function(a){this.elements.$suggestBox.fadeOut(250,function(){a&&a()})},replace:function(a){switch(this.type){case "textarea":this.replaceTextbox(a);
break;case "html":this.replaceHtml(a)}},replaceWord:function(a,b){return a.replace(RegExp("([^a-zA-Z\\u00A1-\\uFFFF]?)("+this.$curWord.text()+")([^a-zA-Z\\u00A1-\\uFFFF]?)","g"),"$1"+b+"$3").replace(RegExp("^("+this.$curWord.text()+")([^a-zA-Z\\u00A1-\\uFFFF])","g"),b+"$2").replace(RegExp("([^a-zA-Z\\u00A1-\\uFFFF])("+this.$curWord.text()+")$","g"),"$1"+b)},replaceTextbox:function(a){this.removeBadword(this.$curWord);this.$domObj.val(this.replaceWord(this.$domObj.val(),a))},replaceHtml:function(a){var b=
this.$domObj.find(".spellcheck-word-highlight:contains("+this.$curWord.text()+")");b.length?b.after(a).remove():(c(this.$domObj).html(this.replaceWord(c(this.$domObj).html(),a)),this.removeBadword(this.$curWord))},ignore:function(){this.type=="textarea"?this.removeBadword(this.$curWord):this.$curWord.after(this.$curWord.html()).remove()},ignoreAll:function(){var a=this;this.type=="textarea"?this.removeBadword(this.$curWord):c(".spellcheck-word-highlight",this.$domObj).each(function(){RegExp(a.$curWord.text(),
"i").test(this.innerHTML)&&c(this).after(this.innerHTML).remove()})},removeBadword:function(a){a.next().hasClass("spellcheck-sep")&&a.next().remove();a.remove();c(".spellcheck-sep",this.elements.$badwords).length?c(".spellcheck-sep:last",this.elements.$badwords).addClass("spellcheck-sep-last"):this.elements.$badwords.remove()},addToDictionary:function(){var a=this;this.hideBox(function(){confirm('Are you sure you want to add the word "'+a.$curWord.text()+'" to the dictionary?')&&a.postJson(a.options.url,
{addtodictionary:a.$curWord.text()},function(){a.ignoreAll();a.check()})})},remove:function(a){a=a||!0;c.each(this.elements.highlightWords,function(){this.after(this.innerHTML).remove()});this.elements.$badwords.remove();this.elements.$suggestBox.remove();c(this.domObj).removeClass("spellcheck-container");a&&c(this.domObj).data("spellchecker",null)},postJson:function(a,b,d){return c.ajax({type:"POST",url:a,data:c.extend(b,{engine:this.options.engine,lang:this.options.lang}),dataType:"json",cache:!1,
error:function(){alert("Sorry, there was an error processing the request.")},success:function(a){d&&d(a)}})},createElements:function(){var a=this;this.elements.$body=this.options.innerDocument?this.$domObj.parents().filter("html:first").find("body"):c("body");this.elements.highlightWords=[];this.elements.$suggestWords=this.elements.$suggestWords||c("<div></div>").addClass("spellcheck-suggestbox-words");this.elements.$ignoreWord=this.elements.$ignoreWord||c('<a href="#">Ignore Word</a>').click(function(b){b.preventDefault();
a.ignore();a.hideBox()});this.elements.$ignoreAllWords=this.elements.$ignoreAllWords||c('<a href="#">Ignore all</a>').click(function(b){b.preventDefault();a.ignoreAll();a.hideBox()});this.elements.$ignoreWordsForever=this.elements.$ignoreWordsForever||c('<a href="#" title="ignore word forever (add to dictionary)">Ignore forever</a>').click(function(b){b.preventDefault();a.addToDictionary();a.hideBox()});this.elements.$suggestFoot=this.elements.$suggestFoot||c("<div></div>").addClass("spellcheck-suggestbox-foot").append(this.elements.$ignoreWord).append(this.elements.$ignoreAllWords).append(this.options.engine==
"pspell"&&a.options.addToDictionary?this.elements.$ignoreWordsForever:!1);this.elements.$badwords=this.elements.$badwords||c("<div></div>").addClass("spellcheck-badwords");this.elements.$suggestBox=this.elements.$suggestBox||c("<div></div>").addClass("spellcheck-suggestbox").append(this.elements.$suggestWords).append(this.elements.$suggestFoot).prependTo(this.elements.$body)}}})(jQuery);